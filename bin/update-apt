#!/bin/sh
set -euf

# Apt package manager for Debian Linux, Ubuntu Linux, etc.
#
# If you want the system to force saying yes, use this setting:
#
#     sudo apt --yes --force-yes ...
#
# If you want the update to be quieter, use the --quiet option:
#
#     sudo apt --quiet ...
#
# If you want the system to automatically use default answers whenever an
# interactive prompt appears, use this setting:
#
#     sudo DEBIAN_FRONTEND=noninteractive apt ...
#
# If you want to combine all of the above:
#
#     sudo DEBIAN_FRONTEND=noninteractive apt --quiet --yes --force-yes ...
#
# Guide to perform an unattended installation of a Debian package:
# http://www.microhowto.info/howto/perform_an_unattended_installation_of_a_debian_package.html
#
# This script attempts 3 kinds of upgrades in order of complexity: upgrade,
# dist-upgrade, full-upgrade.
#
# From the man page:
#
# * upgrade is used to install the newest versions of all packages currently
#   installed on the system from the sources enumerated in
#   /etc/apt/sources.list. Packages currently installed with new versions
#   available are retrieved and upgraded; under no circumstances are currently
#   installed packages removed, or packages not already installed retrieved and
#   installed. New versions of currently installed packages that cannot be
#   upgraded without changing the install status of another package will be left
#   at their current version. An update must be performed first so that apt
#   knows that new versions of packages are available.
#
# * dist-upgrade in addition to performing the function of upgrade, also
#   intelligently handles changing dependencies with new versions of packages;
#   apt has a "smart" conflict resolution system, and it will attempt to upgrade
#   the most important packages at the expense of less important ones if
#   necessary. So, dist-upgrade command may remove some packages. The
#   /etc/apt/sources.list file contains a list of locations from which to
#   retrieve desired package files. See also apt_preferences(5) for a mechanism
#   for overriding the general settings for individual packages.
#
# * full-upgrade performs the function of upgrade but may also remove installed
#   packages if that is required in order to resolve a package conflict. 
#
# Notes:
#
# * Some documentation and the apt source code seems to show that the command
#   full-upgrade is merely an alias for the command dist-upgrade; however, we
#   haven't seen a spec that promises that the two commands are guaranteed to
#   behave identically. So we do both, just in case there's ever a difference.
#
# ## Sources
#
# A vanilla installation of Debian 12 code name "bookworm" has a configuration
# file `/etc/apt/sources.list` with these lines:
#
# ```txt
# deb http://deb.debian.org/debian bookworm main non-free-firmware
# deb-src http://deb.debian.org/debian bookworm main non-free-firmware
#
# deb http://deb.debian.org/debian-security/ bookworm-security main non-free-firmware
# deb-src http://deb.debian.org/debian-security/ bookworm-security main non-free-firmware
#
# deb http://deb.debian.org/debian bookworm-updates main non-free-firmware
# deb-src http://deb.debian.org/debian bookworm-updates main non-free-firmware
# ```
#
# This script updates the file from Debian version-specific code names, such as
# Debian 12 "bookworm" or Debian 13 "trixie", to the Debian "stable" which is
# always the current stable version. Some developers prefer to use Debian
# "testing" which has more-frequent updates but may be less stable.

if command -v apt >/dev/null 2>&1; then
    # Optional for some versions: get update-manager and update-manager-core
    apt --quiet --yes install update-manager
    apt --quiet --yes install update-manager-core
    # Update current release
    apt --quiet --yes update
    apt --quiet --yes upgrade --fix-broken --fix-missing
    apt --quiet --yes dist-upgrade --fix-broken --fix-missing
    apt --quiet --yes full-upgrade --fix-broken --fix-missing
    apt --quiet --yes autoclean
    apt --quiet --yes --purge autoremove
    # Update code name from Debian 12 "bookworm" or Debian 13 "trixie" to "stable"
    sed -i.bak 's/ bookworm / stable /g; s/ bookworm-/ stable-/g;' /etc/apt/sources.list
    sed -i.bak 's/ trixie / stable /g; s/ trixie-/ stable-/g;' /etc/apt/sources.list
    # Update to new release
    apt --quiet --yes update
    apt --quiet --yes upgrade --fix-broken --fix-missing
    apt --quiet --yes dist-upgrade --fix-broken --fix-missing
    apt --quiet --yes full-upgrade --fix-broken --fix-missing
    apt --quiet --yes autoclean
    apt --quiet --yes --purge autoremove
fi
